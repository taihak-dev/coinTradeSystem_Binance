# 📈 코인 자동매매 시스템 (Coin Trade System) 사용 설명서

환영합니다! 이 문서는 **비트코인(BTC) 및 알트코인 선물 거래 자동매매 프로그램**을 처음 사용하는 분들을 위한 상세 가이드입니다.
프로그래밍 지식이 없어도 차근차근 따라 하시면 나만의 트레이딩 봇을 운영하실 수 있습니다.

---

## 📑 목차

1.  [프로그램 소개](#1-프로그램-소개)
2.  [시작하기 전 준비 (환경 설정)](#2-시작하기-전-준비-환경-설정)
3.  [데이터 수집 (백테스트 준비)](#3-데이터-수집-백테스트-준비)
4.  [백테스트 (전략 검증)](#4-백테스트-전략-검증)
5.  [실전 매매 준비 (설정)](#5-실전-매매-준비-설정)
6.  [프로그램 실행](#6-프로그램-실행)
7.  [주요 코드 분석 (개발자용)](#7-주요-코드-분석-개발자용)

---

## 1. 프로그램 소개

이 프로그램은 **'순환형 자산 관리(Cyclical Asset Management)'** 전략을 기반으로 동작하는 선물 거래 봇입니다.

### 💡 핵심 전략
*   **분할 매수 (DCA):** 가격이 떨어지면 조금씩 더 사서 평균 단가를 낮춥니다. (물타기)
*   **리밸런싱 (Rebalancing):** 가격이 반등하면, 물타기 기준점을 높여서 너무 일찍 사는 것을 방지합니다.
*   **수익 리셋 (Profit Reset):** 목표 수익(예: 100%)을 달성하면, 수익금을 따로 챙겨두고 원금으로 다시 시작합니다. (복리의 마법 + 안전성)
*   **손절 및 부활 (Phoenix):** 감당할 수 없는 손실(예: -35%)이 발생하면 과감히 손절하고, 24시간 휴식 후 다시 시작합니다.

---

## 2. 시작하기 전 준비 (환경 설정)

프로그램을 돌리기 위한 기초 공사 단계입니다.

### 1단계: 파이썬(Python) 설치
이 프로그램은 파이썬 언어로 만들어졌습니다. 컴퓨터에 파이썬이 설치되어 있어야 합니다.
*   [파이썬 공식 홈페이지](https://www.python.org/downloads/)에서 최신 버전을 다운로드하여 설치하세요.
*   **주의:** 설치 시 **"Add Python to PATH"** 체크박스를 꼭 체크해주세요!

### 2단계: 프로젝트 폴더 열기
1.  다운로드 받은 프로그램 폴더를 엽니다.
2.  폴더 빈 공간에 `Shift` 키를 누른 채로 `마우스 오른쪽 클릭` -> **"여기서 PowerShell 창 열기"** (또는 터미널 열기)를 선택합니다.

### 3단계: 가상환경 만들기 (선택 사항이지만 권장)
프로그램 전용 공간을 만드는 작업입니다. 터미널에 아래 명령어를 입력하고 엔터를 치세요.
```bash
python -m venv .venv
```

### 4단계: 가상환경 실행
*   **Windows:**
    ```bash
    .\.venv\Scripts\activate
    ```
*   **Mac/Linux:**
    ```bash
    source .venv/bin/activate
    ```
*(명령어 입력 후 줄 맨 앞에 `(.venv)`라고 표시되면 성공입니다!)*

### 5단계: 필수 패키지 설치
프로그램 실행에 필요한 도구들을 설치합니다.
```bash
pip install -r requirements.txt
```

---

## 3. 데이터 수집 (백테스트 준비)

과거 데이터를 가지고 전략을 테스트해보기 위해, 거래소에서 캔들(차트) 데이터를 받아옵니다.

1.  `candle_collector_new.py` (또는 유사한 이름의 수집 스크립트)를 실행합니다.
    ```bash
    python candle_collector_new.py
    ```
2.  수집된 데이터는 `db/candle_db.sqlite` 파일에 저장됩니다. 이 파일이 있어야 백테스트가 가능합니다.

---

## 4. 백테스트 (전략 검증)

내 전략이 과거에 얼마나 벌었을지, 얼마나 위험했을지 미리 확인해보는 과정입니다.

### 1단계: 테스트 설정
`stress_test_btc_final.py` 파일을 메모장이나 에디터로 엽니다.
상단에 있는 `GRID_PARAMS` 부분을 수정하여 테스트하고 싶은 조건을 설정할 수 있습니다.

```python
GRID_PARAMS = {
    "UNIT_SIZE": [100.0],       # 기본 주문 금액
    "LEVERAGE": [1, 2, 3],      # 레버리지 배수
    "PROFIT_RESET_TARGET": [None, 0.10, 0.20] # 수익 리셋 목표 (None은 안 함, 0.10은 10%)
    # ...
}
```

### 2단계: 테스트 실행
터미널에 아래 명령어를 입력합니다.
```bash
python stress_test_btc_final.py
```

### 3단계: 결과 확인
테스트가 끝나면 화면에 요약 결과가 출력되고, `stress_test_btc_final_result.csv` 파일로도 저장됩니다.
*   **Net Profit:** 순수익
*   **MDD:** 최대 낙폭 (가장 많이 잃었을 때의 비율, 낮을수록 안전)
*   **ROI:** 수익률

---

## 5. 실전 매매 준비 (설정)

이제 진짜 돈을 걸고 매매하기 위한 설정을 합니다. **가장 중요한 단계입니다.**

### 1단계: `.env` 파일 설정 (계좌 및 비밀번호)
프로젝트 폴더에 `.env` 파일을 만들고(이미 있다면 열어서), 아래 내용을 채워 넣으세요.
*(메모장으로 열 수 있습니다.)*

```ini
# --- 거래소 설정 (바이비트 예시) ---
EXCHANGE=bybit
BYBIT_API_KEY=내_API_키_붙여넣기
BYBIT_API_SECRET=내_시크릿_키_붙여넣기

# --- 텔레그램 알림 설정 (필수) ---
TELEGRAM_BOT_TOKEN=내_봇_토큰
TELEGRAM_CHAT_ID=내_챗_ID

# --- 자금 관리 설정 ---
# 동적 유닛 사용 여부 (True: 자산 늘어나면 배팅액도 늘림 / False: 고정)
ENABLE_DYNAMIC_UNIT=False
# 기준 시드머니 (이 금액을 기준으로 배팅액 계산)
ORIGINAL_INITIAL_CASH=3000

# --- 전략 설정 ---
# 리밸런싱 기능 사용 여부 (True 권장)
ENABLE_REBALANCE=True
# 목표 수익률 (1.0 = 100% 달성 시 알림)
PROFIT_RESET_TARGET=1.0
# 손절 기준 (0.65 = 자산이 65% 이하로 줄어들면 손절)
STOP_LOSS_THRESHOLD=0.65
# 손절 후 휴식 시간 (분 단위, 1440 = 24시간)
COOLDOWN_MINUTES=1440
```

### 2단계: `setting.csv` 파일 설정 (매매 파라미터)
`setting.csv` 파일을 열어 매매할 코인과 세부 전략을 설정합니다.

| 항목 | 설명 | 예시 값 |
| :--- | :--- | :--- |
| **market** | 거래할 코인 심볼 | BTCUSDT |
| **initial_entry_units** | 최초 진입 시 배수 (기본 유닛 * 배수) | 2 |
| **unit_size** | 기본 유닛 금액 (USDT) | 350 |
| **small_flow_pct** | 1차 물타기 하락률 | 0.04 (4%) |
| **small_flow_units** | 1차 물타기 배수 | 2 |
| **large_flow_pct** | 2차 물타기 하락률 | 0.17 (17%) |
| **large_flow_units** | 2차 물타기 배수 | 10 |
| **take_profit_pct** | 익절 수익률 | 0.006 (0.6%) |
| **leverage** | 레버리지 | 10 |

---

## 6. 프로그램 실행

모든 준비가 끝났습니다! 봇을 실행해봅시다.

### 실행하기
터미널에 아래 명령어를 입력합니다.
```bash
python main.py
```

### 정상 작동 확인
1.  터미널에 `[SYSTEM] Main: ...` 로그가 뜨는지 확인합니다.
2.  텔레그램으로 **"✅ [봇 상태] 시작"** 메시지가 오는지 확인합니다.
3.  잠시 후 **"[📊 포지션/계좌 현황 요약]"** 메시지가 오면 정상입니다.

### 종료하기
터미널 창에서 `Ctrl` + `C` 키를 누르면 안전하게 종료됩니다.

---

## 7. 주요 코드 분석 (개발자용)

이 섹션은 프로그램의 내부 구조와 각 파일/함수의 역할을 설명합니다.

### `main.py`
프로그램의 시작점이자 전체 흐름을 제어하는 지휘관입니다.
*   **`main()`**:
    *   **역할**: 무한 루프를 돌며 매매 사이클을 실행하고, 손절/쿨다운 등 최상위 상태를 관리합니다.
    *   **주요 로직**:
        1.  계좌 정보(`total_equity`) 조회
        2.  쿨다운 상태 확인 및 재개 조건 검사
        3.  손절 조건 확인 및 전체 포지션 청산 명령
        4.  `check_and_notify_status()` 호출 (주기적 알림)
        5.  `run_casino_entry()` 호출 (실제 매매 로직 실행)

### `strategy/`
실제 매매 전략을 결정하는 두뇌 역할을 하는 파일들이 모여있습니다.
*   **`entry.py` -> `run_casino_entry()`**:
    *   **역할**: 매수와 매도 로직의 실행 순서를 결정하는 중간 관리자입니다.
    *   **파라미터**: `current_unit_size` (동적으로 계산된 현재 유닛 사이즈)
*   **`buy_entry.py` -> `run_buy_entry_flow()`**:
    *   **역할**: 매수와 관련된 모든 작업을 총괄합니다. (주문 상태 확인, 현재가 조회, HWM 갱신, 신규 주문 생성 요청)
*   **`sell_entry.py` -> `run_sell_entry_flow()`**:
    *   **역할**: 매도와 관련된 모든 작업을 총괄합니다. (주문 상태 확인, 익절 주문 생성 요청)
*   **`casino_strategy.py` -> `generate_buy_orders()`**:
    *   **역할**: **전략의 핵심.** 모든 상태와 설정값을 바탕으로 'initial', 'small_flow', 'large_flow' 매수 주문을 생성할지 여부를 최종 결정합니다.
    *   **주요 파라미터**: `setting_df`, `buy_log_df`, `current_prices`, `holdings`, `usdt_balance`
    *   **반환값**: 생성된 신규 주문 목록 (Pandas DataFrame)

### `manager/`
봇의 상태를 기억하고, 실제 주문을 실행하는 행동대장 역할을 합니다.
*   **`order_executor.py` -> `execute_buy_orders()`, `close_all_positions()`**:
    *   **역할**: 생성된 주문 목록을 받아, 거래소 API를 통해 실제 주문을 전송합니다.
*   **`hwm_manager.py`**:
    *   **역할**: `hwm_data.json` 파일을 통해 전고점(HWM)을 영구적으로 관리합니다. 리밸런싱 전략의 핵심입니다.
*   **`cooldown_manager.py`**:
    *   **역할**: `cooldown_status.json` 파일을 통해 손절 후 쿨다운 상태를 영구적으로 관리합니다.

### `api/`
거래소와 직접 통신하는 역할을 담당합니다.
*   **`bybit/client.py` -> `get_bybit_client()`**:
    *   **역할**: API 키로 인증된 클라이언트 객체를 생성하고 관리합니다. (싱글톤)
*   **`bybit/account.py` -> `get_accounts()`**:
    *   **역할**: 계좌의 모든 정보(총자산, 가용 잔고, 미실현 손익, 현재 포지션 등)를 조회하여 하나의 딕셔너리로 반환합니다.
    *   **반환값**: `{"total_wallet_balance": ..., "usdt_balance": ..., "open_positions": [...]}`

---

### ⚠️ 주의사항
*   **투자의 책임:** 이 프로그램은 수익을 보장하지 않습니다. 모든 투자의 책임은 사용자 본인에게 있습니다.
*   **API 키 보안:** `.env` 파일은 절대 다른 사람에게 공유하지 마세요.
*   **모니터링:** 봇이 잘 돌아가고 있는지 텔레그램 알림을 자주 확인해주세요.

**성공적인 투자를 기원합니다! 🚀**