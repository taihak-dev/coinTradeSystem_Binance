# 프로젝트 아키텍처 및 기능 분석 보고서 (2025-12-30)

## 1. 프로젝트 개요

이 프로젝트는 **단일 마켓(Single-Asset)**을 대상으로 하는 **선물 거래 자동매매 시스템**입니다. 초기에는 다중 마켓 지원을 고려한 흔적이 있으나, '청산 방어'와 '정교한 자산 관리'를 위한 기능들이 추가되면서 **단일 계좌의 총자산을 기준으로 모든 전략을 수행하는 구조**로 진화했습니다.

**주요 기술 스택:**
*   **언어:** Python
*   **핵심 라이브러리:** `pandas`, `requests`, `pybit` (Bybit), `python-binance` (Binance)
*   **데이터 저장:** `sqlite3` (캔들 데이터), `csv` (거래 로그), `json` (상태 관리)

---

## 2. 핵심 기능 및 모듈 분석

### A. 실전 매매 (Live Trading) - `main.py` 중심

*   **진입점 (`main.py`):** 무한 루프를 돌며 정해진 주기(`RUN_INTERVAL_SECONDS`)마다 매매 사이클을 실행합니다.
*   **설정 관리 (`config.py`, `.env`, `setting.csv`):**
    *   `.env`: API 키, 텔레그램 정보, 자산 관리(초기 자본, 손절 기준 등)와 같은 민감하거나 핵심적인 설정을 관리합니다.
    *   `config.py`: `.env` 파일의 설정을 읽어와 프로그램 전역에서 사용할 수 있도록 변수화합니다.
    *   `setting.csv`: `unit_size`, `leverage` 등 마켓에 특화된 매매 전략 파라미터를 관리합니다.
*   **매매 전략 실행 (`strategy/`):**
    *   `entry.py`: 매수(`buy_entry.py`)와 매도(`sell_entry.py`) 로직의 실행 흐름을 제어합니다.
    *   `buy_entry.py` / `sell_entry.py`: 주문 상태를 확인하고, `casino_strategy.py`를 호출하여 신규 주문을 생성하며, `order_executor.py`를 통해 주문을 실행합니다.
    *   `casino_strategy.py`: **핵심 두뇌.** 현재 상태(보유 포지션, HWM 등)와 설정값을 바탕으로 `initial`, `small_flow`, `large_flow` 등 구체적인 매수 주문을 생성합니다.
*   **상태 관리 (`manager/`):**
    *   `hwm_manager.py`: 전고점(HWM)을 `json` 파일에 저장하여 리밸런싱 전략에 사용합니다.
    *   `cooldown_manager.py`: 손절 후 재매매를 막는 쿨다운 상태를 `json` 파일로 관리합니다.
*   **거래소 통신 (`api/`):**
    *   `binance/` & `bybit/`: 각 거래소의 API와 통신하는 저수준(low-level) 모듈입니다. `client` (연결), `account` (계좌 정보), `order` (주문 실행), `price` (시세 조회) 등으로 역할이 명확히 분리되어 있습니다.
*   **유틸리티 (`utils/`):**
    *   `telegram_notifier.py`: 텔레그램으로 모든 이벤트(시작, 종료, 주문, 에러 등)를 알립니다.
    *   `*_price_utils.py`: 거래소의 규칙(tickSize, stepSize)에 맞게 가격과 수량을 보정하는 중요한 역할을 합니다.

### B. 전략 검증 (Backtesting) - `stress_test_btc_final.py` 중심

*   **독립적 시뮬레이션 엔진:** 라이브 코드와 분리된 자체 시뮬레이션 엔진(`run_simulation`)을 내장하고 있어, 라이브 코드 수정 없이 안전하게 전략을 테스트할 수 있습니다.
*   **그리드 서치:** `GRID_PARAMS`에 정의된 모든 파라미터 조합을 자동으로 테스트하여 최적의 설정값을 찾는 데 특화되어 있습니다.
*   **다층적 전략 검증:** 단순 매매뿐만 아니라, **손절/리필(불사조)**, **수익 리셋(순환)**, **리밸런싱**, **마진 버퍼** 등 라이브 코드의 모든 핵심 전략을 시뮬레이션에 포함하여 현실과 가장 가까운 테스트를 수행합니다.

---

## 3. 잠재적 개선점 및 권장 사항

1.  **상태 관리 통합 (제안되었던 내용):**
    *   현재 `buy_log.csv`, `sell_log.csv`, `hwm_data.json`, `cooldown_status.json` 등 여러 파일에 상태 정보가 분산되어 있습니다. 이를 **단일 `bot_state.json`으로 통합**하는 리팩토링을 진행하면, 프로그램 재시작 시 상태 복구 로직이 훨씬 더 명확하고 안정적으로 변할 것입니다. (현재 설계는 매우 좋으며, 다음 단계로 진행하기에 충분합니다.)

2.  **`FutureWarning` 해결:**
    *   로그에 간헐적으로 표시되는 `FutureWarning: The behavior of DataFrame concatenation...` 메시지는 `pd.concat`이 빈 데이터프레임과 합쳐질 때 발생합니다.
    *   `stress_test_btc_final.py`에서는 이 문제를 해결했지만, 라이브 코드인 `buy_entry.py`와 `sell_entry.py`에는 아직 남아있습니다. `pd.concat` 대신 `pd.concat([df1, df2])`와 같이 리스트로 감싸거나, `loc`을 이용한 행 추가 방식으로 변경하여 경고를 제거하는 것이 좋습니다.

3.  **API 호출 최적화:**
    *   현재 `main.py`, `buy_entry.py`, `sell_entry.py` 등 여러 파일에서 `get_accounts()` 함수를 개별적으로 호출하고 있습니다.
    *   `main.py`의 메인 루프 시작 시 `get_accounts()`를 한 번만 호출하고, 그 결과를 각 하위 함수에 파라미터로 전달하는 방식으로 개선하면 불필요한 API 호출을 줄여 속도와 안정성을 높일 수 있습니다. (현재 `main.py`는 이미 이 구조로 일부 개선되었습니다.)

4.  **문서화 및 주석:**
    *   `manual/README.md`가 추가되어 사용자 편의성이 크게 향상되었습니다.
    *   각 함수의 역할, 파라미터, 반환값 등에 대한 주석(Docstring)을 조금 더 보강하면, 미래에 코드를 유지보수하기가 훨씬 수월해질 것입니다.

---

## 4. 총평

이 프로젝트는 **단순한 매매 스크립트에서 시작하여, 정교한 리스크 관리와 자산 관리 전략이 포함된 자동매매 시스템으로 매우 잘 발전**했습니다. 특히 라이브 코드와 테스트 코드를 분리하고, 각 모듈의 역할을 명확히 나눈 점은 훌륭한 아키텍처 설계입니다.

위에 제안된 몇 가지 개선점을 적용한다면, 코드의 안정성과 효율성을 한 단계 더 높일 수 있을 것입니다.